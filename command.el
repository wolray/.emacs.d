(defun BackwardKillLine ()
  (interactive)
  (kill-region
   (line-beginning-position) (point))
  (indent-for-tab-command))

(defun CopyBuffer ()
  (interactive)
  (kill-ring-save
   (point-min) (point-max))
  (message "(CopyBuffer)"))

(defun CycleParenShapes ()
  (interactive)
  (save-excursion
    (unless (looking-at-p (rx (any "([")))
      (backward-up-list))
    (let ((pt (point))
          (new (cond ((looking-at-p (rx "(")) (cons "[" "]"))
                     ((looking-at-p (rx "[")) (cons "(" ")"))
                     (t (beep) nil))))
      (when new
        (forward-sexp)
        (delete-char -1)
        (insert (cdr new))
        (goto-char pt)
        (delete-char 1)
        (insert (car new))))))

(defun KillRegion ()
  (interactive)
  (if (region-active-p)
      (kill-region (region-beginning) (region-end))
    (kill-whole-line 1)))
(defun KillRingSave ()
  (interactive)
  (if (region-active-p)
      (kill-ring-save
       (region-beginning) (region-end))
    (kill-ring-save
     (line-beginning-position) (line-end-position))))

(defun OrgMakeTdiffString (diff)
  (let ((y (floor (/ diff 365)))
	(d (mod diff 365))
	(fmt "")
	(l nil))
    (cond ((= diff 0)
	   (setq fmt "today"))
	  ((< diff 0)
	   (if (< y 0)
	       (setq fmt (concat fmt "%d year"  (if (< y -1) "s") " ")
		     l (push (- y) l)))
	   (setq fmt (concat fmt "%d day"  (if (< d 364) "s") " until")
		 l (push (- 365 d) l)))
	  ((> diff 0)
	   (if (> y 0)
	       (setq fmt (concat fmt "%d year"  (if (> y 1) "s") " ")
		     l (push y l)))
	   (setq fmt (concat fmt "%d day"  (if (> d 1) "s") " since")
		 l (push d l))))
    (apply 'format fmt (nreverse l))))
(defun OrgEvaluateTimeRange ()
  (interactive)
  (or
   (org-clock-update-time-maybe)
   (save-excursion
     (unless (org-at-timestamp-p)
       (goto-char (line-beginning-position))
       (re-search-forward org-tsr-regexp (line-end-position) t))
     (unless (org-at-timestamp-p)
       (user-error "")))
   (let* ((ts1 (match-string 0))
	  (time1 (org-time-string-to-time ts1))
	  (t1 (time-to-days time1))
	  (t2 (time-to-days (current-time)))
	  (diff (- t2 t1)))
     (message "%s" (OrgMakeTdiffString diff)))))

(defun PythonShellSendLine ()
  (interactive)
  (python-shell-send-region
   (line-beginning-position) (line-end-position)))

(defun RacketSendBuffer ()
  (interactive)
  (set-mark (point))
  (racket-send-region
   (point-min) (point-max)))

(defun SearchWhitespaceRegexp ()
  (interactive)
  (if (equal search-whitespace-regexp "\\s-+")
      (progn
	(setq search-whitespace-regexp ".*?")
	(message "(search-whitespace-regexp \".*?\")"))
    (progn
      (setq search-whitespace-regexp "\\s-+")
      (message "(search-whitespace-regexp \"\\\\s-+\")"))))

(defun SortLines ()
  (interactive)
  (when (region-active-p)
    (sort-lines nil (region-beginning) (region-end))))
(defun SortParagraphs ()
  (interactive)
  (sort-paragraphs nil (point-min) (point-max))
  (message "(SortParagraphs)"))

(defun SwitchToBufferScratch ()
  (interactive)
  (switch-to-buffer "*scratch*"))

(defun ToggleComment (beg end)
  (interactive (if (use-region-p)
		   (list (region-beginning) (region-end))
		 (list (line-beginning-position)
		       (line-beginning-position 2))))
  (comment-or-uncomment-region beg end))

(defun TransposeLinesUp ()
  (interactive)
  (move-beginning-of-line 1)
  (unless (or (bobp) (eobp))
    (next-line 1)
    (transpose-lines -1)
    (previous-line 2))
  (back-to-indentation))
(defun TransposeLinesDown ()
  (interactive)
  (move-end-of-line 1)
  (unless (eobp)
    (next-line 1)
    (unless (eobp)
      (transpose-lines 1)
      (previous-line 1)
      (move-end-of-line 1))))

(defun TransposeParagraphsUp ()
  (interactive)
  (backward-paragraph 1)
  (if (bobp) (forward-paragraph)
    (progn
      (forward-paragraph 1)
      (transpose-paragraphs -1)
      (backward-paragraph 1))))
(defun TransposeParagraphsDown ()
  (interactive)
  (backward-paragraph 1)
  (forward-paragraph 1)
  (unless (eobp)
    (transpose-paragraphs 1)))

(defvar page-range 10)
(make-variable-buffer-local 'page-range)
(defun TogglePageRange ()
  (interactive)
  (cond ((= page-range 10) (setq page-range 20))
	((= page-range 20) (setq page-range 50))
	((= page-range 50) (setq page-range 10))
	(t (setq page-range 10)))
  (message (format "(page-range %d)" page-range)))
(defun PageUp ()
  (interactive)
  (move-beginning-of-line (- (1- page-range))))
(defun PageDown ()
  (interactive)
  (move-beginning-of-line (1+ page-range)))

(defvar paragraph-origin (cons "\f\\|[ \t]*$" "[ \t\f]*$"))
(defun ParagraphSet ()
  (interactive)
  (setq paragraph-start (car paragraph-origin)
	paragraph-separate (cdr paragraph-origin))
  (message "(ParagraphSet)"))

(defvar skip-chars " \t")
(make-variable-buffer-local 'skip-chars)
(defun MoveBeginningOfLine ()
  (interactive)
  (skip-chars-backward skip-chars)
  (move-beginning-of-line (if (bolp) 0 1))
  (skip-chars-forward skip-chars))
(defun MoveBeginningOfLineOrigin ()
  (interactive)
  (move-beginning-of-line (if (bolp) 0 1)))
(defun MoveEndOfLine ()
  (interactive)
  (move-end-of-line (if (eolp) 2 1)))

(defvar word-case nil)
(defun ToggleWordCase ()
  (interactive)
  (unless (eq this-command last-command) (setq word-case nil))
  (cond ((equal word-case nil) (capitalize-word -1) (setq word-case "c"))
	((equal word-case "c") (upcase-word -1) (setq word-case "u"))
	((equal word-case "u") (downcase-word -1) (setq word-case nil))))
